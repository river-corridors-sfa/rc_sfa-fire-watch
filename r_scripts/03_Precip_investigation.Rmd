---
title: "03_Precip_investigation"
output: html_document
date: "2024-08-28"
editor_options: 
  chunk_output_type: console
---

The purpose of this script is to investigate the historical precip data in and around the Tieton watershed

Script Workflow:

Step 1) Load in precipitation data from the hydromet station database: https://www.usbr.gov/pn/hydromet/yakima/yakwebarcread.html

Step 2) Plot the time series and perform some summary stats to get an idea of when it rains

Step 3) Plot high precip events

RESULTS:
1) September 17th would be the first day of rain that exceeds the historical average daily rainfall event.
2) The range of dates where we experience a rain event that exceeds 0.47 inches (precip required to trigger a double in Q) in this area in a day is: 9/7 - 10/30. The average date in this range is October 18th. 


# Status: in progress

# ==============================================================================
# Author: Jake Cavaiani; jake.cavaiani@pnnl.gov 
# 28 August 2024
# ==============================================================================

## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

# Load the packages
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(here)
library(nhdplusTools)
library(furrr)
library(readr)
library(lubridate)
library(dataRetrieval)
```

# Hydromet TICW (could use as an Oak Creek Proxy precip data) 
```{r}
ticw_daily_precip <- read_csv(here("inputs", "Climate", "tieton_ticw_daily_precip.csv"), 
                              skip = 1)

ticw_daily_precip <- ticw_daily_precip %>% 
  mutate(DateTime = mdy(DateTime)) %>% 
  na.omit(ticw_pp) %>% 
  filter(ticw_pp >= 0 & ticw_pp <= 10)

# Plot time series
ggplot(ticw_daily_precip, aes(x = DateTime, y = ticw_pp)) +
  geom_bar(stat = "identity") + 
  scale_y_reverse() +
  ylim(5,0) +
  labs(x = "Date", y = "Precipitation (In)", title = "Daily Precipitation Time Series") +
  theme_bw()  

```

# Investigate first rain day above average for each year
```{r}
# Extract year and month from the Date column
ticw_daily_precip <- ticw_daily_precip %>%
  mutate(Year = year(DateTime), Month = month(DateTime), Day = day(DateTime))

# Calculate the first day with precipitation greater than the average after August for each year
first_high_precip_day <- ticw_daily_precip %>%
  group_by(Year) %>%
  mutate(Avg_Precip = mean(ticw_pp, na.rm = TRUE)) %>% 
  filter(ticw_pp > Avg_Precip) %>% 
  filter(Month > 8) %>% 
  slice_min(DateTime) %>%  # Find the first day with precipitation greater than the average
  ungroup()  # Ungroup to finalize the data frame

first_precip_days <- first_high_precip_day %>% 
  pull(DateTime)

# ggplot(ticw_daily_precip, aes(x = DateTime, y = ticw_pp)) +
#   geom_bar(stat = "identity") + 
#   scale_y_reverse() +
#   ylim(5,0) +
#   geom_vline(xintercept = as.numeric(first_precip_days), color = "red", linetype = "dashed") +  
#   labs(x = "Date", y = "Precipitation (In)", title = "Daily Precipitation Time Series") +
#   theme_bw()  


# Calculate the average day #
average_month_day <- first_high_precip_day %>%
  mutate(DayOfYear = yday(DateTime)) %>%  
  summarise(AverageDayOfYear = mean(DayOfYear, na.rm = TRUE)) %>%  
  pull(AverageDayOfYear) %>%  
  as.Date(origin = "1970-01-01") %>%  
  format("%m-%d")  

range(first_high_precip_day$Month)
range(first_high_precip_day$Day)

# Range: 9/2 - 10/22

# * Septmeber 17th!* #
```
This shows that September 17th would be the first day of rain that exceeds the average rainfall. 

# Extract hydrologic data
```{r American River}
# American River Near Nile, WA - 12488500
siteNo <- "12488500"
pCode <- "00060"
start.date <- "2014-01-01"
end.date <- "2024-08-01"

american <- readNWISuv(siteNumbers = siteNo,
                     parameterCd = pCode,
                     startDate = start.date,
                     endDate = end.date)

# Fix the names 
american <- renameNWISColumns(american)

parameterInfo <- attr(american, "variableInfo")
siteInfo <- attr(american, "siteInfo")

# plot 
ggplot(data = american, aes(x = dateTime, y = Flow_Inst)) +
  geom_line() +
  xlab("") +
  ylab(parameterInfo$variableDescription) +
  ggtitle(siteInfo$station_nm) +
  theme_bw()

# calculate daily average Q #
american <- american %>%
  mutate(Year = year(dateTime), Month = month(dateTime), Day = day(dateTime))

daily_avg <- american %>% 
  group_by(Year, Month, Day) %>% 
  summarize(daily_discharge = mean(Flow_Inst, na.rm = TRUE))

# Extract days where discharge doubled
# Create a lagged column for comparison
daily_avg <- daily_avg %>%
  arrange(Year, Month, Day) %>%
  mutate(previous_day_discharge = lag(daily_discharge)) %>%
  filter(!is.na(previous_day_discharge)) %>%
  mutate(doubled_discharge = daily_discharge >= 2 * previous_day_discharge) %>%
  filter(doubled_discharge)

# Create a Date column and pull the date when discharge doubles
doubled_discharge <- daily_avg %>%
  mutate(DateTime = make_date(Year, Month, Day)) %>% 
  select(DateTime, daily_discharge, previous_day_discharge) %>% 
  pull(DateTime)

# Create a vector that also includes the previous day
previous_days_vector <- doubled_discharge - 1

# Merge the two
all_days_vector <- c(previous_days_vector, doubled_discharge)

# Pull the precip for these days
precip_doubled_discharge <- ticw_daily_precip %>% 
  filter(DateTime %in% all_days_vector)

summary_precip <- precip_doubled_discharge %>% 
  summarize(mean_precip = mean(ticw_pp))

```
0.4758442 inches in a day is the mean precipitation that makes the American River double in Q

```{r Toppenish Creek - USGS gauge: 12506000}
# Toppenish Creek near Fort Simcoe, WA - 12506000
siteNo <- "12506000"
pCode <- "00060"
start.date <- "2014-01-01"
end.date <- "2024-08-01"

toppenish <- readNWISuv(siteNumbers = siteNo,
                     parameterCd = pCode,
                     startDate = start.date,
                     endDate = end.date)

# Fix the names 
toppenish <- renameNWISColumns(toppenish)

parameterInfo <- attr(toppenish, "variableInfo")
siteInfo <- attr(toppenish, "siteInfo")

# plot 
ggplot(data = toppenish, aes(x = dateTime, y = Flow_Inst)) +
  geom_line() +
  xlab("") +
  ylab(parameterInfo$variableDescription) +
  ggtitle(siteInfo$station_nm) +
  theme_bw()

# calculate daily average Q #
toppenish <- toppenish %>%
  mutate(Year = year(dateTime), Month = month(dateTime), Day = day(dateTime))

daily_avg <- toppenish %>% 
  group_by(Year, Month, Day) %>% 
  summarize(daily_discharge = mean(Flow_Inst, na.rm = TRUE))

# Extract days where discharge doubled
# Create a lagged column for comparison
daily_avg <- daily_avg %>%
  arrange(Year, Month, Day) %>%
  mutate(previous_day_discharge = lag(daily_discharge)) %>%
  filter(!is.na(previous_day_discharge)) %>%
  mutate(doubled_discharge = daily_discharge >= 2 * previous_day_discharge) %>%
  filter(doubled_discharge)

# Create a Date column and pull the date when discharge doubles
doubled_discharge <- daily_avg %>%
  mutate(DateTime = make_date(Year, Month, Day)) %>% 
  select(DateTime, daily_discharge, previous_day_discharge) %>% 
  pull(DateTime)

# Create a vector that also includes the previous day
previous_days_vector <- doubled_discharge - 1

# Merge the two
all_days_vector <- c(previous_days_vector, doubled_discharge)

# Pull the precip for these days
precip_doubled_discharge <- ticw_daily_precip %>% 
  filter(DateTime %in% all_days_vector)

summary_precip <- precip_doubled_discharge %>% 
  summarize(mean_precip = mean(ticw_pp))


```
0.4905455 inches in a day is the mean precipitation that makes the Toppenish River double in Q


# Investigate days where we saw discharge double (from down below script) 
```{r}
# Filter the dates with precipitation greater than 2 inches
high_discharge_days <- ticw_daily_precip %>%
  filter(ticw_pp > 0.47) %>%
  filter(Month > 8 & Month < 11) %>% 
  pull(DateTime)

# Calculate the average month and day
high_average_month_day <- high_discharge_days %>%
  # Extract the day of the year
  yday() %>%
  # Calculate the average day of the year
  mean(na.rm = TRUE) %>%
  # Convert the average day of the year to Date format
  as.Date(origin = "1970-01-01") %>%
  # Format to get just month and day
  format("%m-%d")

ggplot(ticw_daily_precip, aes(x = DateTime, y = ticw_pp)) +
  geom_bar(stat = "identity") + 
  scale_y_reverse() +
  ylim(5,0) +
  geom_vline(xintercept = as.numeric(high_discharge_days), color = "red", linetype = "dashed") +  
  labs(x = "Date", y = "Precipitation (In)", title = "Daily Precipitation Time Series") +
  theme_bw()  

# Only looking at one year 
ggplot(ticw_daily_precip, aes(x = DateTime, y = ticw_pp)) +
  geom_bar(stat = "identity") + 
  scale_y_reverse() +
  ylim(5,0) +
  scale_x_date(limits = as.Date(c("2019-10-01", "2020-09-30"))) +
  geom_vline(xintercept = as.numeric(high_discharge_days), color = "red", linetype = "dashed") +  
  labs(x = "Date", y = "Precipitation (In)", title = "Daily Precipitation Time Series") +
  theme_bw()  
  
       

```
The range of dates where we experience a rain event that is > 0.47 inches in this area in a day is: 9/7 - 10/30

The average date where a rain event exceeds 0.47 inches in this area is: October 18th. 

















