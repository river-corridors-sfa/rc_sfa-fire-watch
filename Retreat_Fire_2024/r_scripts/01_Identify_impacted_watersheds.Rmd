---
title: "01_Identify_impacted_watersheds"
output: html_document
date: "2024-08-16"
editor_options: 
  chunk_output_type: console
---

The purpose of this script is to load in active fire shape files and then identify flowlines that are influenced downstream of them. 

Script Workflow:

Step 1)

Step 2) 

Step 3) 


# Status: in progress

# ==============================================================================
# Author: Jake Cavaiani; jake.cavaiani@pnnl.gov 
# 16 August 2024
# ==============================================================================

## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

# Load the packages
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(here)
library(nhdplusTools)
library(furrr)
library(readr)
library(raster)
library(exactextractr)
library(purrr)
library(stringr)
library(forcats)
library(lwgeom)
```


```{r Plot Yakima River Basin with Retreat Fire}

# Load your local shapefile (replace with your file path)
retreat_shape <- st_read(here("Retreat_Fire_2024", "inputs", "shape_files", "Retreat_Fire.shp"))

ggplot(data = retreat_shape) +
  geom_sf(fill = "transparent", color = "red") # Overlay the shapefile

# Plot Yakima River Basin (YRB)
yakima_shape <- st_read(here("Yakima_River_Basin_shape_files", "Yakima_River_Basin.shp"))

ggplot(data = yakima_shape) +
  geom_sf(fill = "lightblue", color = "black") +  # Plot Yakima River Basin
  geom_sf(data = retreat_shape, fill = "transparent", color = "red") + # Overlay the shapefile
  theme_bw()

# Plot Gauge sites 
yakima_gage_shape <- st_read(here("Yakima_River_Basin_shape_files", "Yakama_Gages.shp")) 

ggplot(data = yakima_shape) +
  geom_sf(fill = "lightblue", color = "black") + # Plot Yakima River Basin
  geom_sf(data = retreat_shape, fill = "transparent", color = "red") +
  geom_sf(data = yakima_gage_shape, color = "darkred") +
  theme_bw()

# Plot HUCs with data
huc10_with_data <- st_read(here("Yakima_River_Basin_shape_files", "Huc10_withData", "Huc10_withData.shp")) 

ggplot(data = huc10_with_data) +
  geom_sf(fill = "darkgreen", alpha = 0.2, color = "black") + 
  geom_sf(data = yakima_shape, fill = "lightblue", alpha = 0.75, color = "black") +
  geom_sf(data = retreat_shape, fill = "transparent", color = "red") +
  geom_sf(data = yakima_gage_shape, color = "darkred") +
  theme_bw()

```

```{r pulling SFA site info and getting HUCs}
# Reading in data package data of coordinates of all of our sites
sfa_coords <- read_csv(here("RCSFA_Geospatial_Site_Info", "v3_RCSFA_Geospatial_Site_Information.csv"))

# Adding North Fork Cowiche Creek because it is another HUC in the Retreat Fire perimeter
new_row <- tibble(
  Site_ID = "North_Fork_Cowiche_Creek",
  Latitude = 46.701784,
  Longitude = -120.858173,
  COMID = 24423497
)

# Add the new row to the existing dataframe
sfa_coords <- bind_rows(sfa_coords, new_row)


# Converting to a sf object
sfa_coords <- sfa_coords %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  dplyr::select(Site_ID, COMID, geometry) %>% 
  dplyr::mutate(usgs_id = NA) %>% 
  filter(COMID != -9999)



sfa_coords_filter <- sfa_coords %>% 
  filter(Site_ID %in% c("S49R", "S50P", "S55", "S56", "S65", "North_Fork_Cowiche_Creek"))

# Pull HUCs by site_id
pull_huc12 <- function(i){
  
  x <- sfa_coords %>% slice(i)
  
  get_huc(AOI = x, 
          type = "huc12") %>% 
    mutate(Site_ID = x$Site_ID) %>% 
    dplyr::select(huc12, 
           Site_ID)
}

## Pull HUC12s for all sites
hucs_by_site <- 1:nrow(sfa_coords) %>% 
  future_map(pull_huc12) %>% 
  bind_rows()

## From 328 sites to 184 unique HUC8s
## From 328 sites to 242 unique HUC12s
unique_hucs <- hucs_by_site %>% 
  distinct(huc12, .keep_all = TRUE)

# Peter code
# Find HUCs that intersect with fire 

# interesect_huc_and_fire <- function(i){
# 
#   huc <- unique_hucs %>% slice(i)
# 
#   st_intersection(huc, retreat_shape) %>%
#     st_drop_geometry() %>%
#     mutate(huc12 = huc$huc12) %>%
#     select(fire_id, huc12)
# }
# 
# # 1-10
# hucs_and_mtbs <- 1:10 %>%
#   #1 %>%
#   future_map(interesect_huc_and_fire) %>%
#   bind_rows()
# 
# write_csv(hucs_and_mtbs, "data/240801_intersecting_hucs_and_mtbs_1-50.csv")

# # Find HUCs that intersect with fire 
hucs_fire_intersection <- st_intersection(unique_hucs, retreat_shape)

hucs_intersected <- unique_hucs[st_intersects(unique_hucs, retreat_shape, sparse = FALSE), ]

# Write the sf object to a shapefile
st_write(hucs_intersected, here("Retreat_Fire_2024", "output_for_analysis", "01_Identify_impacted_watersheds", "intersected_watersheds.shp"))

intersected_hucs_df <- as.data.frame(hucs_intersected)

intersected_hucs_df <- intersected_hucs_df %>% 
  mutate(huc12 = as.numeric(huc12))

# Plot HUCS that intersect with fire perimeter 
ggplot() +
  geom_sf(data = hucs_intersected, fill = "lightblue", alpha = 0.25, color = "darkblue") +
  geom_sf(data = retreat_shape, fill = "red", alpha = 0.5) +
  theme_minimal() +
  labs(title = "HUCs Intersecting with Fire Perimeter",
       x = "Longitude",
       y = "Latitude")

# Get spatial data with associated comids
# Define your COMIDs of interest
comids <- sfa_coords_filter %>% 
  pull(COMID)
# comids <- c(24423233, 24422713, 24423517, 24424705)  # S49R, S50P, S55, S65

# Get the flowline data for the specified COMIDs
flowlines <- get_nhdplus(comid = comids, realization = "flowline")

# Plot the flowlines using ggplot2
ggplot() +
  geom_sf(data = hucs_intersected, fill = "lightblue", alpha = 0.25, color = "black") +
  geom_sf(data = flowlines, color = "blue", size = 1) +
  geom_sf(data = retreat_shape, fill = "red", alpha = 0.5) +
  theme_bw() +
  labs(title = "Flowlines with HUCs that intersect the Retreat Fire",
       x = "Longitude",
       y = "Latitude")

# Pull the comid from the flowlines closest to the site
site_comid <- flowlines %>% 
  slice(st_nearest_feature(hucs_intersected))

# Pull comids inside fire
fire_flowlines <- st_intersection(retreat_shape, flowlines)

# TEST SUBSET FlOWLINES
# # Subset flowlines to everything upstream of site_comid
# upstream_flowlines <- flowlines %>%
#     filter(comid %in% get_UT(flowlines, comid = site_comid %>% pull(comid)))

upstream_flowlines <- get_UT(flowlines, comids)

upstream_flowlines <- get_nhdplus(comid = upstream_flowlines, realization = "flowline")



# Plot the flowlines using ggplot2
ggplot() +
  geom_sf(data = hucs_intersected, fill = "lightblue", alpha = 0.25, color = "black") +
  geom_sf(data = flowlines, color = "blue", size = 1) +
  geom_sf(data = upstream_flowlines, color = "green", size = 1) +
  geom_sf(data = retreat_shape, fill = "red", alpha = 0.5) +
  theme_bw() +
  labs(title = "Flowlines with HUCs that intersect the Retreat Fire",
       x = "Longitude",
       y = "Latitude")

```


#### Burn Severity 
# Convert crs function 
```{r crs function}
convert_crs <- function (input, goal, type = "numeric", res = NULL) 
{
    stopifnot(class(input)[1] %in% c("sf", "RasterLayer"), class(goal)[1] %in% 
        c("sf", "RasterLayer"), type %in% c("numeric", "categorical"))
    if (raster::compareCRS(goal, input) == T) {
        message("CRS already matches that of your goal object")
        return(input)
    }
    else {
        if (class(input)[1] == "RasterLayer") {
            if (is.null(res)) {
                if (class(goal)[1] == "RasterLayer") {
                  res <- terra::res(goal)[1]
                }
                else {
                  unit <- sf::st_crs(goal, parameters = TRUE)$units_gdal
                  res <- ifelse(unit == "degree", 0.0003280119, 
                    30)
                }
            }
            method <- ifelse(type == "numeric", "bilinear", "ngb")
            input_prj <- raster::projectRaster(input, crs = raster::crs(goal), 
                method = method, res = res)
        }
        else {
            input_prj <- sf::st_transform(input, raster::crs(goal))
        }
        return(input_prj)
    }
}

```

# Function to clip raster to a shapefile 
```{r function}
# This function will ensure the projection is the same between the raster the shapefile and then clip the raster to the basin boundry. It can return a raster (for further analysis) or a dataframe (for plotting)

#' @param raster the raster you want to clip
#' @param sf the shapefile you want to use to clip the raster
#' @param type either 'numeric' or 'categorical' depending on if your raster is discrete or continuous values
#' @param res the resolution of the projected raster, if not specified with default to 30m
#' @param return either 'df' or 'raster' to specify the form of the returned raster
#'
#' @return if 'return' is df it will return the raster as a dataframe suitable 
#' for plotting in ggplot2. If 'return' is raster it will return the raster as a rasterLayer object

clean_raster <- function (raster, sf, type = "numeric", 
                            res = NULL, return = "df") {stopifnot(class(raster) == "RasterLayer", class(sf)[1] == 
                c("sf"), type %in% c("numeric", "categorical"), return %in% 
                c("df", "raster"))
    unit <- sf::st_crs(sf, parameters = TRUE)$units_gdal
    buffer <- ifelse(unit == "degree", 0.1, 5000)
    res <- ifelse(unit == "degree", 0.0003280119, 30)
    method <- ifelse(type == "numeric", "bilinear", "ngb")
    if (compareCRS(raster, sf) == T) {
      raster_crop <- raster::crop(raster, sf)
      raster_crop <- raster::mask(raster_crop, sf)
      raster_df <- as.data.frame(raster::rasterToPoints(raster_crop))
      colnames(raster_df) <- c("x", "y", "val")
    }
    else {
      sf_prj <- convert_crs(sf::st_buffer(sf, dist = buffer), 
                            raster)
      raster_crop <- raster::crop(raster, sf_prj)
      raster_crop <- raster::mask(raster_crop, sf_prj)
      raster_prj <- raster::projectRaster(raster_crop, crs = crs(sf), 
                                          method = method, res = res)
      raster_crop <- raster::crop(raster_prj, sf)
      raster_crop <- raster::mask(raster_crop, sf)
      raster_df <- as.data.frame(raster::rasterToPoints(raster_crop))
      colnames(raster_df) <- c("x", "y", "val")
    }
    if (return == "df") {
      raster_df
    }
    else {
      raster_crop
    }
} 

```

# Oak Creek Test
```{r}
# Read in watershed shape file
oak_creek_tribs_shape <- st_read(here("Retreat_Fire_2024", "output_for_analysis", "02_Retreat_Fire_Site_Selection", "Oak_Creek_tribs.shp")) 

# Read in pole creek fire 
retreat_shape <- read_sf(here("Retreat_Fire_2024", "inputs", "shape_files", "Retreat_Fire.shp"))

retreat_shape <- st_zm(retreat_shape)

# Plot fire shape file 
ggplot(data = retreat_shape) +
  geom_sf(aes(fill = "red")) +
  theme_minimal()

# plot on top of each other 
ggplot() +
  geom_sf(data = oak_creek_tribs_shape, fill = "#56B4E9", alpha = 0.2, color = "black") +
  geom_sf(data = retreat_shape, fill = "red", alpha = 0.2, color = "black") +
  theme_minimal()

# Pull the dnbrs for the Retreat Fire
retreat_dnbr <- raster(here("Retreat_Fire_2024", "inputs", "shape_files", "dNBR_RetreatFire.tif"))

# # Clip data to the watershed
dnbr <- clean_raster(retreat_dnbr, retreat_shape, type = "numeric", return="raster")
plot(dnbr) #use to make sure it's doing what you expect

```

# Watershed DNBR values
```{r Clint Canyon}
# Read in watershed shape file
clint_shape <- st_read(here("Retreat_Fire_2024", "output_for_analysis", "02_Retreat_Fire_Site_Selection", "Oak_Creek_tribs.shp")) %>% 
  filter(site == "Clint Canyon")

# plot to make sure this is correct
ggplot() +
  geom_sf(data = clint_shape, fill = "#56B4E9", alpha = 0.2, color = "black") +
  theme_minimal()

basin_dnbr <- clean_raster(dnbr, clint_shape,  type = "numeric", return="raster")
plot(basin_dnbr) #use to make sure it's doing what you expect

# make sure basin and fire layer are the same projection
if(compareCRS(dnbr, clint_shape) == F){
      basin_pj <- st_transform(clint_shape, crs(dnbr))}else{
        basin_pj <- clint_shape
      }

#extract data
mean_dnbr <- exactextractr::exact_extract(dnbr,basin_pj, "mean", 
                                           progress=F) 

# Clint Canyon mean dNBR  - 207.204971313477

# burn_severity_thresholds <- burn_severity_thresholds %>% 
#   mutate(mean_dnbr = case_when(site == "Benjamin_Slough" ~ 457.194000244141,
#                                          TRUE ~ mean_dnbr))


```

###### PULL HUC shape file for Oak Creek ######
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

# Load the packages
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(here)
library(nhdplusTools)
library(furrr)

```

```{r Plot Yakima River Basin with Retreat Fire}
# Load your local shapefile (replace with your file path)
retreat_shape <- st_read(here("Fires_2024", "Retreat_Fire", "Retreat_Fire.shp"))

ggplot(data = retreat_shape) +
  geom_sf(fill = "transparent", color = "red") # Overlay the shapefile


# Reading in data package data of coordinates of all of our sites
oak_creek_coords <- read_csv(here("Fires_2024", "Retreat_Fire", "site_selection", "initial_search",
                                  "oak_creek_precip_gage_comp.csv"))

# Converting to a sf object
oak_creek_coords <- oak_creek_coords %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
  # dplyr::select(Site_ID, COMID, geometry) %>% 
  # dplyr::mutate(usgs_id = NA) %>% 
  # filter(COMID != -9999)

# Pull HUCs by site_id
pull_huc10 <- function(i){
  
  x <- oak_creek_coords %>% slice(i)
  
  get_huc(AOI = x, 
          type = "huc10") %>% 
    mutate(site = x$site) %>% 
    dplyr::select(huc10, 
           site)
}

## Pull HUC12s for all sites
hucs_by_site <- 1:nrow(oak_creek_coords) %>% 
  future_map(pull_huc10) %>% 
  bind_rows()


unique_hucs <- hucs_by_site %>% 
  distinct(huc10, .keep_all = TRUE)


# Plot the flowlines using ggplot2
ggplot() +
  geom_sf(data = unique_hucs, fill = "lightblue", alpha = 0.25, color = "black") +
  # geom_sf(data = flowlines, color = "blue", size = 1) +
  geom_sf(data = retreat_shape, fill = "red", alpha = 0.5) +
  theme_bw() +
  labs(title = "Flowlines with HUCs that intersect the Retreat Fire",
       x = "Longitude",
       y = "Latitude")

oak_creek_shape <- unique_hucs %>% 
  filter(site == "Oak_Creek")
  
# Export to a shapefile
st_write(oak_creek_shape, "~/GitHub/rc_sfa-fire-watch/Fires_2024/Retreat_Fire/site_selection/initial_search/oak_creek_shapefile.shp", driver = "ESRI Shapefile")

```




